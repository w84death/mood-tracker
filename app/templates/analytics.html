<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Personal Health Tracker - Analytics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìà Health Analytics</h1>
        <p>Visualize correlations between your health metrics and environmental factors</p>

        {% set current_page = 'analytics' %}
        {% include 'nav_buttons.html' %}
      </div>

      <div class="analytics-container">
        {% if error %}
        <div class="error-message">
          <h3>Error loading analytics data</h3>
          <p>{{ error }}</p>
        </div>
        {% elif not daily_data %}
        <div class="empty-state">
          <h3>No data available</h3>
          <p>Start tracking your health metrics to see analytics!</p>
          <a href="{{ url_for('timeline') }}" class="nav-btn" style="display: inline-block; margin-top: 1rem;">
            üåü Go to Timeline
          </a>
        </div>
        {% else %}
        
        <!-- Overview Stats -->
        <div class="stats-overview">
          <div class="stat-card">
            <span class="stat-emoji">üòä</span>
            <div class="stat-value" id="avgMood">-</div>
            <div class="stat-label">Avg Mood</div>
          </div>
          <div class="stat-card">
            <span class="stat-emoji">‚ö°</span>
            <div class="stat-value" id="avgEnergy">-</div>
            <div class="stat-label">Avg Energy</div>
          </div>
          <div class="stat-card">
            <span class="stat-emoji">üå°Ô∏è</span>
            <div class="stat-value" id="avgTemp">-</div>
            <div class="stat-label">Avg Temperature</div>
          </div>
          <div class="stat-card">
            <span class="stat-emoji">üçÉ</span>
            <div class="stat-value" id="avgAQI">-</div>
            <div class="stat-label">Avg Air Quality</div>
          </div>
          <div class="stat-card">
            <span class="stat-emoji">‚òÄÔ∏è</span>
            <div class="stat-value" id="avgDaylight">-</div>
            <div class="stat-label">Avg Daylight</div>
          </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
          <!-- Mood & Energy Trends -->
          <div class="chart-container">
            <h3 class="chart-title">üòä Mood & Energy Trends</h3>
            <canvas id="moodEnergyChart"></canvas>
          </div>

          <!-- Weather Correlation -->
          <div class="chart-container">
            <h3 class="chart-title">üå§Ô∏è Weather vs Mood</h3>
            <canvas id="weatherMoodChart"></canvas>
          </div>

          <!-- Sleep Quality Analysis -->
          <div class="chart-container">
            <h3 class="chart-title">üò¥ Sleep Quality Impact</h3>
            <canvas id="sleepQualityChart"></canvas>
          </div>

          <!-- Environmental Factors -->
          <div class="chart-container">
            <h3 class="chart-title">üåç Environmental Factors</h3>
            <canvas id="environmentalChart"></canvas>
          </div>

          <!-- Energy vs Weather -->
          <!-- Energy vs Environmental -->
          <div class="chart-container">
            <h3 class="chart-title">‚ö° Energy vs Environmental</h3>
            <canvas id="energyEnvironmentalChart"></canvas>
          </div>

          <!-- Air Quality & Daylight -->
          <div class="chart-container">
            <h3 class="chart-title">üçÉ Air Quality & Daylight</h3>
            <canvas id="airQualityChart"></canvas>
          </div>

          <!-- Biorhythm Cycles -->
          <div class="chart-container">
            <h3 class="chart-title">üîÑ Biorhythm Cycles</h3>
            <canvas id="biorhythmChart"></canvas>
          </div>

          <!-- Moon Phase Correlation -->
          <div class="chart-container">
            <h3 class="chart-title">üåô Moon Phase Influence</h3>
            <canvas id="moonPhaseChart"></canvas>
          </div>
        </div>

        <!-- Insights Section -->
        <div class="insights-section">
          <h3 class="insights-title">üîç Key Insights</h3>
          <div class="insights-grid" id="insightsGrid">
            <!-- Insights will be generated by JavaScript -->
          </div>
        </div>

        {% endif %}
      </div>
    </div>

    <style>
      .analytics-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
      }

      .stats-overview {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 2px solid #e2e8f0;
      }

      .stat-emoji {
        font-size: 2.5rem;
        display: block;
        margin-bottom: 0.5rem;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.25rem;
      }

      .stat-label {
        font-size: 0.9rem;
        color: #64748b;
        font-weight: 500;
      }

      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
      }

      .chart-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 2px solid #e2e8f0;
        height: 400px;
        position: relative;
        overflow: hidden;
      }

      .chart-title {
        color: #1e293b;
        margin-bottom: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
      }

      .chart-container canvas {
        max-height: 320px !important;
        max-width: 100% !important;
        width: 100% !important;
        height: 320px !important;
      }

      .insights-section {
        background: linear-gradient(135deg, #fefce8, #fef3c7);
        border: 2px solid #eab308;
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 2rem;
      }

      .insights-title {
        color: #92400e;
        margin-bottom: 1rem;
        font-size: 1.25rem;
        font-weight: 600;
      }

      .insights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
      }

      .insight-card {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        border-left: 4px solid #eab308;
      }

      .insight-card h4 {
        color: #92400e;
        margin-bottom: 0.5rem;
        font-size: 1rem;
      }

      .insight-card p {
        color: #374151;
        font-size: 0.9rem;
        margin: 0;
      }

      .error-message {
        background: #fef2f2;
        border: 2px solid #fecaca;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        color: #dc2626;
      }

      .empty-state {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 3rem;
        text-align: center;
        color: #64748b;
      }

      @media (max-width: 768px) {
        .charts-grid {
          grid-template-columns: 1fr;
        }
        
        .stats-overview {
          grid-template-columns: repeat(3, 1fr);
        }
        
        .chart-container {
          padding: 1rem;
          height: 350px;
        }
        
        .chart-container canvas {
          height: 270px !important;
          max-height: 270px !important;
        }
        
        .insights-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 480px) {
        .stats-overview {
          grid-template-columns: 1fr;
        }
      }
    </style>

    <script>
      // Data from backend
      const dailyData = {{ daily_data | tojson }};
      
      // Process data for charts
      const dates = dailyData.map(d => d.date);
      const moods = dailyData.map(d => d.avg_mood);
      const energies = dailyData.map(d => d.avg_energy);
      const sleepQuality = dailyData.map(d => d.sleep_quality);
      const temperatures = dailyData.map(d => d.temperature);
      const humidity = dailyData.map(d => d.humidity);
      const airPressure = dailyData.map(d => d.air_pressure);
      const airQuality = dailyData.map(d => d.aqi);
      const daylightHours = dailyData.map(d => d.daylight_hours);
      const moonIllumination = dailyData.map(d => d.moon_illumination);
      
      // Process biorhythm data
      const biorhythmPhysical = dailyData.map(d => d.biorhythms ? d.biorhythms.physical?.value : null);
      const biorhythmEmotional = dailyData.map(d => d.biorhythms ? d.biorhythms.emotional?.value : null);
      const biorhythmIntellectual = dailyData.map(d => d.biorhythms ? d.biorhythms.intellectual?.value : null);

      // Calculate overview stats
      function calculateStats() {
        const validMoods = moods.filter(m => m !== null);
        const validEnergies = energies.filter(e => e !== null);

        const validTemps = temperatures.filter(t => t !== null && t !== undefined && t > -50 && t < 60);
        const validAQI = airQuality.filter(a => a !== null);
        const validDaylight = daylightHours.filter(d => d !== null);

        document.getElementById('avgMood').textContent = validMoods.length ? 
          (validMoods.reduce((a, b) => a + b, 0) / validMoods.length).toFixed(1) + '/5' : 'N/A';
        document.getElementById('avgEnergy').textContent = validEnergies.length ? 
          (validEnergies.reduce((a, b) => a + b, 0) / validEnergies.length).toFixed(1) + '/5' : 'N/A';

        document.getElementById('avgTemp').textContent = validTemps.length ? 
          (validTemps.reduce((a, b) => a + b, 0) / validTemps.length).toFixed(1) + '¬∞C' : 'N/A';
        document.getElementById('avgAQI').textContent = validAQI.length ? 
          (validAQI.reduce((a, b) => a + b, 0) / validAQI.length).toFixed(1) : 'N/A';
        document.getElementById('avgDaylight').textContent = validDaylight.length ? 
          (validDaylight.reduce((a, b) => a + b, 0) / validDaylight.length).toFixed(1) + 'h' : 'N/A';
      }

      // Chart configurations
      const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        aspectRatio: 2,
        interaction: {
          intersect: false,
          mode: 'index'
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'day',
              displayFormats: {
                day: 'MMM dd'
              }
            },
            grid: {
              display: true,
              color: 'rgba(0, 0, 0, 0.1)'
            }
          }
        },
        plugins: {
          legend: {
            position: 'top',
            labels: {
              boxWidth: 12,
              padding: 15
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: 'white',
            bodyColor: 'white',
            cornerRadius: 6
          }
        },
        elements: {
          point: {
            radius: 4,
            hoverRadius: 6
          },
          line: {
            borderWidth: 2
          }
        }
      };

      // Data validation and range calculation
      function getDataRange(data, defaultMin = 0, defaultMax = 5) {
        const validData = data.filter(d => d !== null && d !== undefined);
        if (validData.length === 0) return { min: defaultMin, max: defaultMax };
        
        const min = Math.min(...validData);
        const max = Math.max(...validData);
        const padding = (max - min) * 0.1 || 0.5; // 10% padding or 0.5 if no range
        
        return {
          min: Math.max(defaultMin, min - padding),
          max: Math.min(defaultMax, max + padding)
        };
      }

      // Create charts
      function createCharts() {
        // Mood & Energy Trends
        new Chart(document.getElementById('moodEnergyChart'), {
          type: 'line',
          data: {
            labels: dates,
            datasets: [{
              label: 'Mood',
              data: moods,
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              tension: 0.4,
              fill: false
            }, {
              label: 'Energy',
              data: energies,
              borderColor: '#f59e0b',
              backgroundColor: 'rgba(245, 158, 11, 0.1)',
              tension: 0.4,
              fill: false
            }]
          },
          options: {
            ...chartOptions,
            scales: {
              ...chartOptions.scales,
              y: {
                min: 0,
                max: 5,
                ticks: {
                  stepSize: 1,
                  callback: function(value) {
                    return value + '/5';
                  }
                },
                title: {
                  display: true,
                  text: 'Rating (1-5)'
                },
                grid: {
                  color: 'rgba(0, 0, 0, 0.1)'
                }
              }
            }
          }
        });

        // Air Quality & Daylight Chart
        const aqiRange = getDataRange(airQuality, 1, 5);
        const daylightRange = getDataRange(daylightHours, 0, 24);
        
        new Chart(document.getElementById('airQualityChart'), {
          type: 'line',
          data: {
            labels: dates,
            datasets: [{
              label: 'Air Quality Index',
              data: airQuality,
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              yAxisID: 'y',
              tension: 0.4,
              fill: false
            }, {
              label: 'Daylight Hours',
              data: daylightHours,
              borderColor: '#f59e0b',
              backgroundColor: 'rgba(245, 158, 11, 0.1)',
              yAxisID: 'y1',
              tension: 0.4,
              fill: false
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                min: aqiRange.min,
                max: aqiRange.max,
                title: {
                  display: true,
                  text: 'Air Quality Index'
                },
                grid: {
                  drawOnChartArea: false,
                }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                min: daylightRange.min,
                max: daylightRange.max,
                title: {
                  display: true,
                  text: 'Daylight Hours'
                },
                grid: {
                  drawOnChartArea: false,
                }
              }
            }
          }
        });

        // Weather vs Mood
        const tempMoodData = dailyData.filter(d => d.temperature && d.avg_mood);
        const tempRange = getDataRange(tempMoodData.map(d => d.temperature), -10, 40);
        
        new Chart(document.getElementById('weatherMoodChart'), {
          type: 'scatter',
          data: {
            datasets: [{
              label: 'Temperature vs Mood',
              data: tempMoodData.map(d => ({
                x: d.temperature,
                y: d.avg_mood
              })),
              backgroundColor: 'rgba(59, 130, 246, 0.6)',
              borderColor: '#3b82f6',
              pointRadius: 6,
              pointHoverRadius: 8
            }]
          },
          options: {
            ...chartOptions,
            scales: {
              x: {
                min: tempRange.min,
                max: tempRange.max,
                title: {
                  display: true,
                  text: 'Temperature (¬∞C)'
                },
                grid: {
                  color: 'rgba(0, 0, 0, 0.1)'
                }
              },
              y: {
                min: 0,
                max: 5,
                ticks: {
                  stepSize: 1,
                  callback: function(value) {
                    return value + '/5';
                  }
                },
                title: {
                  display: true,
                  text: 'Mood (1-5)'
                },
                grid: {
                  color: 'rgba(0, 0, 0, 0.1)'
                }
              }
            }
          }
        });

        // Sleep Quality
        new Chart(document.getElementById('sleepQualityChart'), {
          type: 'bar',
          data: {
            labels: dates,
            datasets: [{
              label: 'Sleep Quality',
              data: sleepQuality,
              backgroundColor: 'rgba(139, 92, 246, 0.6)',
              borderColor: '#8b5cf6',
              borderWidth: 2,
              borderRadius: 4
            }]
          },
          options: {
            ...chartOptions,
            scales: {
              ...chartOptions.scales,
              y: {
                min: 0,
                max: 5,
                ticks: {
                  stepSize: 1,
                  callback: function(value) {
                    return value + '/5';
                  }
                },
                title: {
                  display: true,
                  text: 'Sleep Quality (1-5)'
                },
                grid: {
                  color: 'rgba(0, 0, 0, 0.1)'
                }
              }
            }
          }
        });

        // Environmental Factors
        const tempEnvRange = getDataRange(temperatures, -10, 40);
        const humidityRange = getDataRange(humidity, 0, 100);
        
        new Chart(document.getElementById('environmentalChart'), {
          type: 'line',
          data: {
            labels: dates,
            datasets: [{
              label: 'Temperature (¬∞C)',
              data: temperatures,
              borderColor: '#ef4444',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              yAxisID: 'y',
              tension: 0.4,
              fill: false
            }, {
              label: 'Humidity (%)',
              data: humidity,
              borderColor: '#06b6d4',
              backgroundColor: 'rgba(6, 182, 212, 0.1)',
              yAxisID: 'y1',
              tension: 0.4,
              fill: false
            }]
          },
          options: {
            ...chartOptions,
            scales: {
              ...chartOptions.scales,
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                min: tempEnvRange.min,
                max: tempEnvRange.max,
                title: {
                  display: true,
                  text: 'Temperature (¬∞C)'
                },
                grid: {
                  color: 'rgba(239, 68, 68, 0.2)'
                }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                min: humidityRange.min,
                max: humidityRange.max,
                title: {
                  display: true,
                  text: 'Humidity (%)'
                },
                grid: {
                  drawOnChartArea: false,
                  color: 'rgba(6, 182, 212, 0.2)'
                }
              }
            }
          }
        });

        // Energy vs Environmental - Combined chart with multiple environmental factors
        const energyDataWithEnv = dailyData.filter(d => d.avg_energy && 
          (d.air_pressure || d.temperature || d.humidity || d.daylight_hours));
        
        if (energyDataWithEnv.length > 0) {
          // Filter datasets that have actual data
          const datasets = [];
          
          // Air Pressure vs Energy
          const pressureData = energyDataWithEnv.filter(d => d.air_pressure);
          if (pressureData.length > 0) {
            datasets.push({
              label: 'Air Pressure vs Energy',
              data: pressureData.map(d => ({
                x: d.air_pressure,
                y: d.avg_energy
              })),
              backgroundColor: 'rgba(245, 158, 11, 0.6)',
              borderColor: '#f59e0b',
              pointRadius: 6,
              pointHoverRadius: 8,
              xAxisID: 'x'
            });
          }
          
          // Temperature vs Energy (if different from pressure data)
          const tempData = energyDataWithEnv.filter(d => d.temperature);
          if (tempData.length > 0) {
            datasets.push({
              label: 'Temperature vs Energy',
              data: tempData.map(d => ({
                x: d.temperature,
                y: d.avg_energy
              })),
              backgroundColor: 'rgba(239, 68, 68, 0.6)',
              borderColor: '#ef4444',
              pointRadius: 6,
              pointHoverRadius: 8,
              xAxisID: 'x'
            });
          }
          
          const xMin = Math.min(...energyDataWithEnv.map(d => d.air_pressure || d.temperature || 0).filter(v => v > 0));
          const xMax = Math.max(...energyDataWithEnv.map(d => d.air_pressure || d.temperature || 0));
          
          new Chart(document.getElementById('energyEnvironmentalChart'), {
            type: 'scatter',
            data: { datasets },
            options: {
              ...chartOptions,
              scales: {
                x: {
                  min: xMin * 0.9,
                  max: xMax * 1.1,
                  title: {
                    display: true,
                    text: 'Environmental Factors'
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                },
                y: {
                  min: 0,
                  max: 5,
                  ticks: {
                    stepSize: 1,
                    callback: function(value) {
                      return value + '/5';
                    }
                  },
                  title: {
                    display: true,
                    text: 'Energy (1-5)'
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                }
              }
            }
          });
        } else {
          // Show message when no data available
          const canvas = document.getElementById('energyEnvironmentalChart');
          const ctx = canvas.getContext('2d');
          ctx.font = '16px Inter';
          ctx.fillStyle = '#6b7280';
          ctx.textAlign = 'center';
          ctx.fillText('No environmental data available', canvas.width/2, canvas.height/2);
        }

        // Biorhythm Cycles Chart
        new Chart(document.getElementById('biorhythmChart'), {
          type: 'line',
          data: {
            labels: dates,
            datasets: [{
              label: 'Physical (23-day cycle)',
              data: biorhythmPhysical,
              borderColor: '#dc2626',
              backgroundColor: 'rgba(220, 38, 38, 0.1)',
              tension: 0.4,
              fill: false
            }, {
              label: 'Emotional (28-day cycle)',
              data: biorhythmEmotional,
              borderColor: '#059669',
              backgroundColor: 'rgba(5, 150, 105, 0.1)',
              tension: 0.4,
              fill: false
            }, {
              label: 'Intellectual (33-day cycle)',
              data: biorhythmIntellectual,
              borderColor: '#7c3aed',
              backgroundColor: 'rgba(124, 58, 237, 0.1)',
              tension: 0.4,
              fill: false
            }]
          },
          options: {
            ...chartOptions,
            scales: {
              ...chartOptions.scales,
              y: {
                min: -1,
                max: 1,
                ticks: {
                  stepSize: 0.5,
                  callback: function(value) {
                    if (value === 1) return 'High (+1)';
                    if (value === 0.5) return '+0.5';
                    if (value === 0) return 'Critical (0)';
                    if (value === -0.5) return '-0.5';
                    if (value === -1) return 'Low (-1)';
                    return value.toFixed(1);
                  }
                },
                title: {
                  display: true,
                  text: 'Biorhythm Value'
                },
                grid: {
                  color: function(context) {
                    return context.tick.value === 0 ? 'rgba(220, 38, 38, 0.5)' : 'rgba(0, 0, 0, 0.1)';
                  }
                }
              }
            }
          }
        });

        // Moon Phase
        new Chart(document.getElementById('moonPhaseChart'), {
          type: 'line',
          data: {
            labels: dates,
            datasets: [{
              label: 'Moon Illumination (%)',
              data: moonIllumination,
              borderColor: '#6366f1',
              backgroundColor: 'rgba(99, 102, 241, 0.1)',
              tension: 0.4,
              yAxisID: 'y',
              fill: false
            }, {
              label: 'Mood',
              data: moods,
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              tension: 0.4,
              yAxisID: 'y1',
              fill: false
            }]
          },
          options: {
            ...chartOptions,
            scales: {
              ...chartOptions.scales,
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                  display: true,
                  text: 'Moon Illumination (%)'
                },
                min: 0,
                max: 100,
                ticks: {
                  stepSize: 20,
                  callback: function(value) {
                    return value + '%';
                  }
                },
                grid: {
                  color: 'rgba(99, 102, 241, 0.2)'
                }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                  display: true,
                  text: 'Mood (1-5)'
                },
                min: 0,
                max: 5,
                ticks: {
                  stepSize: 1,
                  callback: function(value) {
                    return value + '/5';
                  }
                },
                grid: {
                  drawOnChartArea: false,
                  color: 'rgba(16, 185, 129, 0.2)'
                }
              }
            }
          }
        });
      }

      // Generate insights
      function generateInsights() {
        const insights = [];
        
        // Mood-Temperature correlation
        const moodTempData = dailyData.filter(d => d.avg_mood && d.temperature);
        if (moodTempData.length > 5) {
          const avgMoodHot = moodTempData.filter(d => d.temperature > 25).map(d => d.avg_mood);
          const avgMoodCold = moodTempData.filter(d => d.temperature < 15).map(d => d.avg_mood);
          
          if (avgMoodHot.length > 0 && avgMoodCold.length > 0) {
            const hotAvg = avgMoodHot.reduce((a, b) => a + b) / avgMoodHot.length;
            const coldAvg = avgMoodCold.reduce((a, b) => a + b) / avgMoodCold.length;
            
            if (hotAvg > coldAvg + 0.5) {
              insights.push({
                title: 'üå°Ô∏è Temperature & Mood',
                text: `Your mood tends to be ${(hotAvg - coldAvg).toFixed(1)} points higher on warmer days (>25¬∞C) compared to cooler days (<15¬∞C).`
              });
            }
          }
        }

        // Sleep-Mood correlation
        const sleepMoodData = dailyData.filter(d => d.sleep_quality && d.avg_mood);
        if (sleepMoodData.length > 5) {
          const goodSleep = sleepMoodData.filter(d => d.sleep_quality >= 4).map(d => d.avg_mood);
          const poorSleep = sleepMoodData.filter(d => d.sleep_quality <= 2).map(d => d.avg_mood);
          
          if (goodSleep.length > 0 && poorSleep.length > 0) {
            const goodAvg = goodSleep.reduce((a, b) => a + b) / goodSleep.length;
            const poorAvg = poorSleep.reduce((a, b) => a + b) / poorSleep.length;
            
            insights.push({
              title: 'üò¥ Sleep Quality Impact',
              text: `Good sleep quality (4-5) correlates with ${(goodAvg - poorAvg).toFixed(1)} points higher mood compared to poor sleep (1-2).`
            });
          }
        }

        // Air pressure correlation with energy
        const pressureEnergyData = dailyData.filter(d => d.air_pressure && d.avg_energy);
        if (pressureEnergyData.length > 5) {
          const highPressure = pressureEnergyData.filter(d => d.air_pressure > 1020).map(d => d.avg_energy);
          const lowPressure = pressureEnergyData.filter(d => d.air_pressure < 1000).map(d => d.avg_energy);
          
          if (highPressure.length > 0 && lowPressure.length > 0) {
            const highAvg = highPressure.reduce((a, b) => a + b) / highPressure.length;
            const lowAvg = lowPressure.reduce((a, b) => a + b) / lowPressure.length;
            
            if (Math.abs(highAvg - lowAvg) > 0.3) {
              const better = highAvg > lowAvg ? 'high' : 'low';
              const diff = Math.abs(highAvg - lowAvg);
              insights.push({
                title: 'üåÄ Barometric Pressure & Energy',
                text: `Your energy levels tend to be ${diff.toFixed(1)} points ${highAvg > lowAvg ? 'higher' : 'lower'} on ${better} air pressure days.`
              });
            }
          }
        }

        // Air quality correlation with mood
        const aqiMoodData = dailyData.filter(d => d.aqi && d.avg_mood);
        if (aqiMoodData.length > 5) {
          const goodAir = aqiMoodData.filter(d => d.aqi <= 2).map(d => d.avg_mood);
          const poorAir = aqiMoodData.filter(d => d.aqi >= 4).map(d => d.avg_mood);
          
          if (goodAir.length > 0 && poorAir.length > 0) {
            const goodAvg = goodAir.reduce((a, b) => a + b) / goodAir.length;
            const poorAvg = poorAir.reduce((a, b) => a + b) / poorAir.length;
            
            if (Math.abs(goodAvg - poorAvg) > 0.3) {
              insights.push({
                title: 'üçÉ Air Quality & Mood',
                text: `Your mood is ${(goodAvg - poorAvg).toFixed(1)} points higher on days with good air quality (AQI 1-2) compared to poor air quality days (AQI 4-5).`
              });
            }
          }
        }

        // Daylight hours correlation with energy
        const daylightEnergyData = dailyData.filter(d => d.daylight_hours && d.avg_energy);
        if (daylightEnergyData.length > 5) {
          const longDays = daylightEnergyData.filter(d => d.daylight_hours > 12).map(d => d.avg_energy);
          const shortDays = daylightEnergyData.filter(d => d.daylight_hours < 8).map(d => d.avg_energy);
          
          if (longDays.length > 0 && shortDays.length > 0) {
            const longAvg = longDays.reduce((a, b) => a + b) / longDays.length;
            const shortAvg = shortDays.reduce((a, b) => a + b) / shortDays.length;
            
            if (Math.abs(longAvg - shortAvg) > 0.3) {
              insights.push({
                title: '‚òÄÔ∏è Daylight & Energy',
                text: `Your energy levels are ${(longAvg - shortAvg).toFixed(1)} points ${longAvg > shortAvg ? 'higher' : 'lower'} on longer daylight days (>12h) compared to shorter days (<8h).`
              });
            }
          }
        }

        // Display insights
        const insightsGrid = document.getElementById('insightsGrid');
        if (insights.length === 0) {
          insightsGrid.innerHTML = '<p style="text-align: center; color: #6b7280;">Collect more data to see personalized insights!</p>';
        } else {
          insightsGrid.innerHTML = insights.map(insight => `
            <div class="insight-card">
              <h4>${insight.title}</h4>
              <p>${insight.text}</p>
            </div>
          `).join('');
        }
      }

      // Initialize everything
      document.addEventListener('DOMContentLoaded', function() {
        calculateStats();
        createCharts();
        generateInsights();
      });
    </script>
  </body>
</html>